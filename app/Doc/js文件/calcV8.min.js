function WMCMap(){this.elements=new Array();this.size=function(){return this.elements.length};this.isEmpty=function(){return(this.elements.length<1)};this.clear=function(){this.elements=new Array()};this.put=function(b,a){this.remove(b);this.elements.push({key:b,value:a})};this.remove=function(a){var c=false;try{for(i=0;i<this.elements.length;i++){if(this.elements[i].key==a){this.elements.splice(i,1);return true}}}catch(b){c=false}return c};this.get=function(a){try{for(i=0;i<this.elements.length;i++){if(this.elements[i].key==a){return this.elements[i].value}}}catch(b){return null}};this.element=function(a){if(a<0||a>=this.elements.length){return null}return this.elements[a]};this.containsKey=function(a){var c=false;try{for(i=0;i<this.elements.length;i++){if(this.elements[i].key==a){c=true}}}catch(b){c=false}return c};this.containsValue=function(a){var c=false;try{for(i=0;i<this.elements.length;i++){if(this.elements[i].value==a){c=true}}}catch(b){c=false}return c};this.values=function(){var a=new Array();for(i=0;i<this.elements.length;i++){a.push(this.elements[i].value)}return a};this.keys=function(){var a=new Array();for(i=0;i<this.elements.length;i++){a.push(this.elements[i].key)}return a}}Number.prototype.toFixed=function(j){var h=this+"";if(!j){j=0}if(h.indexOf(".")==-1){h+="."}h+=new Array(j+1).join("0");if(new RegExp("^(-|\\+)?(\\d+(\\.\\d{0,"+(j+1)+"})?)\\d*$").test(h)){var h="0"+RegExp.$2,g=RegExp.$1,e=RegExp.$3.length,c=true;if(e==j+2){e=h.match(/\d/g);if(parseInt(e[e.length-1],10)>4){for(var f=e.length-2;f>=0;f--){e[f]=parseInt(e[f],10)+1;if(e[f]==10){e[f]=0;c=f!=1}else{break}}}h=e.join("").replace(new RegExp("(\\d+)(\\d{"+j+"})\\d$"),"$1.$2")}if(c){h=h.substr(1)}return Number((g+h).replace(/\.$/,""))}return Number(this+"")};function accAdd(j,h){var b,a,f,l,c;var g,d;try{g=j.toString().split(".")[1];b=g.length}catch(k){b=0}try{d=h.toString().split(".")[1];a=d.length}catch(k){a=0}f=Math.pow(10,Math.max(b,a));l=j.toString().split(".")[0].toString();if(g){l+=g;if(b<a){l=parseInt(l,10)*Math.pow(10,(a-b))}}else{l=parseInt(l,10)*f}l=parseInt(l,10);c=h.toString().split(".")[0].toString();if(d){c+=d;if(b>a){c=parseInt(c,10)*Math.pow(10,(b-a))}}else{c=parseInt(c,10)*f}c=parseInt(c,10);return(l+c)/f}Number.prototype.add=function(a){return accAdd(a,this)};function accSub(k,j){var c,a,g,b,o,d;var h,f;try{h=k.toString().split(".")[1];c=h.length}catch(l){c=0}try{f=j.toString().split(".")[1];a=f.length}catch(l){a=0}g=Math.pow(10,Math.max(c,a));o=k.toString().split(".")[0].toString();if(h){o+=h;if(c<a){o=parseInt(o,10)*Math.pow(10,(a-c))}}else{o=parseInt(o,10)*g}o=parseInt(o,10);d=j.toString().split(".")[0].toString();if(f){d+=f;if(c>a){d=parseInt(d,10)*Math.pow(10,(c-a))}}else{d=parseInt(d,10)*g}d=parseInt(d,10);return(o-d)/g}Number.prototype.sub=function(a){return accSub(this,a)};function accMul(d,b){var a=0,f=d.toString(),c=b.toString();try{a+=f.split(".")[1].length}catch(g){}try{a+=c.split(".")[1].length}catch(g){}return(Number(f.replace(".",""))*Number(c.replace(".",""))/Math.pow(10,a))}Number.prototype.mul=function(a){return accMul(a,this)};function accDiv(arg1,arg2){var t1=0,t2=0,r1,r2;try{t1=arg1.toString().split(".")[1].length}catch(e){}try{t2=arg2.toString().split(".")[1].length}catch(e){}with(Math){r1=Number(arg1.toString().replace(".",""));r2=Number(arg2.toString().replace(".",""));return((r1/r2)*pow(10,t2-t1))}}Number.prototype.div=function(a){return accDiv(this,a)};PROMOTION_TYPE_AMT=0;PROMOTION_TYPE_PCT=1;PROMOTION_TYPE_AMT_TIERED=2;PROMOTION_TYPE_PCT_TIERED=3;PROMOTION_TYPE_FIXED=4;PROMOTION_TYPE_AMT_ONLINE=6;PROMOTION_TYPE_AMT_ONLINE_TIERED=106;function getOfferById(b){var d;for(var c=0;c<data.length;c++){d=data[c];if(b==d.gpOfferId){var a=d.groups;a.sort(function(f,e){var g=parseInt(e.groupSeq,10)-parseInt(f.groupSeq,10);return g});d.groups=a;return d}}return}function getMapCartItem(a){var f=new WMCMap();var d;var c;var e;for(var b=0;b<a.length;b++){c=a[b];if(c.offerId||c.offerId==0){if(f.containsKey(c.offerId)){d=f.get(c.offerId);if(d.containsKey(c.groupId)){e=d.get(c.groupId);e.push(c);d.put(c.groupId,e)}else{e=new Array();e.push(c);d.put(c.groupId,e)}f.put(c.offerId,d)}else{d=new WMCMap();e=new Array();e.push(c);d.put(c.groupId,e);f.put(c.offerId,d)}}}return f}var RECOMMEND_AMT=1;var RECOMMEND_PCT=20;function contains(c,b){var a=c.length;while(a--){if(c[a].productId===b.productId&&c[a].offerId===b.offerId){return true}}return false}function getGpOfferSet(f){var a=new WMCMap();var c=new WMCMap();for(var g=0;g<f.length;g++){var m=f[g];if(m==null){continue}var d=m.productId;var e=m.gpDiscount;var k=m.taxPrice;var l=m.qty;var j=m.offerId;if(c.containsKey(m.offerId)){m.gpDiscount=0;continue}if(a.isEmpty()){a.put(d,e)}else{if(a.containsKey(d)){var b=a.get(d).add(e).toFixed(2);var h=b.sub(l.mul(k)).toFixed(2);if(h>=0){c.put(j,"")}else{a.put(d,a.get(d).add(e).toFixed(2))}}else{a.put(d,e)}}}return c}function calculateInItemLevel(e,h,o){var j=new Array();for(var f=0;f<e.length;f++){cart=e[f];if(cart.qty>0){j.push(cart)}}var n=new Array();if(j!=null&&j.length>0){var b=getMapCartItem(j);if(b.size()>0){var l;var c;var a=b.elements;for(var f=0;f<a.length;f++){l=getOfferById(a[f].key);var g;if(l){c=a[f].value;switch(l.gpCaclTypeCode){case PROMOTION_TYPE_AMT:g=calculateInItemLevelTypeAMT(l,c,h,o);break;case PROMOTION_TYPE_PCT:g=calculateInItemLevelTypePCT(l,c,h,o);break;case PROMOTION_TYPE_FIXED:g=calculateInItemLevelTypeFixed(l,c,h,o);break;case PROMOTION_TYPE_AMT_TIERED:g=calculateInItemLevelTypeAMTTiered(l,c,h,o);break;case PROMOTION_TYPE_PCT_TIERED:g=calculateInItemLevelTypePCTTiered(l,c,h,o);break;case PROMOTION_TYPE_AMT_ONLINE:g=calculateInItemLevelTypeAMTOnline(l,c,h,o);break;default:break}if(g!=null){for(var d=0;d<g.length;d++){var m=g[d];n.push(m)}}}}}}return n}function calculateInItemLevelTypeAMTTiered(m,d,h,t){var o=new Array();var l=new Array();var r=0;if(m!=null&&d.size()>0){var g=0;var b=m.groups;var n;var a;var l;var q;for(var f=0;f<b.length;f++){n=b[f];a=n.groupSeq;l=d.get(a);var p=0;if(l){for(var c=0;c<l.length;c++){q=l[c];p+=q.qty;g=g.add(q.qty.mul(q.taxPrice));o.push(q)}}var s=n.tieredDiscount;s.sort(function(k,j){return j.thresholdQty-k.thresholdQty});for(var e=0;e<s.length;e++){if(p>=s[e].thresholdQty){r=r.add(s[e].discountFactor);break}}}if(r>=g){r=0}for(var f=0;f<o.length;f++){var q=o[f];if(r==0&&h==t){q.exceptionFlag='"error"'}q.gpDiscount=q.qty.mul(q.taxPrice).mul(r).div(g).toFixed(2);if(!q.gpDiscount){q.gpDiscount=0}o[f]=q}l=balancePriceForItems(r,o)}return l}function calculateInItemLevelTypeAMT(l,f,h,s){var o=new Array();var r=0;var d=0;var c=l.groups;var b=0;var a=99999999;var n;var m;var j;var q;for(var g=0;g<c.length;g++){m=c[g];if(m){n=m.groupSeq;j=f.get(n);var p=0;if(j){for(var e=0;e<j.length;e++){q=j[e];p+=q.qty;d=d.add(q.qty.mul(q.taxPrice));o.push(q)}}b=parseInt(p.div(m.thresholdQty),10);if(b<a){a=b}}}r=a.mul(l.discountFactor);if(r>=d){r=0}for(var g=0;g<o.length;g++){var q=o[g];if(r==0&&h==s){q.exceptionFlag='"error"'}q.gpDiscount=q.qty.mul(q.taxPrice).mul(r).div(d).toFixed(2);if(!q.gpDiscount){q.gpDiscount=0}o[g]=q}var j=balancePriceForItems(r,o);return j}function calculateInItemLevelTypeAMTOnline(m,f,h,s){var p=new Array();var r=0;var d=0;var c=m.groups;var b=0;var a=99999999;var o;var n;var j;var q;var l=m.discountTimes;for(var g=0;g<c.length;g++){n=c[g];if(n){o=n.groupSeq;j=f.get(o);if(j){for(var e=0;e<j.length;e++){q=j[e];d=d.add(q.qty.mul(q.taxPrice));p.push(q)}}b=parseInt(d.div(n.thresholdAmt),10);if(l==0){a=b}else{if(l>b){a=b}else{a=l}}}}r=a.mul(m.discountFactor);if(r>=d){r=0}for(var g=0;g<p.length;g++){var q=p[g];if(r==0&&h==s){q.exceptionFlag='"error"'}q.gpDiscount=q.qty.mul(q.taxPrice).mul(r).div(d).toFixed(2);if(!q.gpDiscount){q.gpDiscount=0}p[g]=q}var j=balancePriceForItems(r,p);return j}function calculateInItemLevelTypePCTTiered(a,q,r,h){var s=new Array();var m=new Array();var b=0;if(a&&q.size()>0){var u=a.groups;var d;var g;var m;var t;var l=0;for(var p=0;p<u.length;p++){d=u[p];if(d){g=d.groupSeq;m=q.get(g);var f=0;var c=0;if(m){for(var n=0;n<m.length;n++){t=m[n];f+=t.qty;c=c.add(t.qty.mul(t.taxPrice));s.push(t)}}l=l.add(c);var v=d&&d.tieredDiscount;v.sort(function(k,j){return j.thresholdQty-k.thresholdQty});var e=0;for(var o=0;o<v.length;o++){if(f>=v[o].thresholdQty){e=v[o].discountFactor;break}}b=b.add(c).mul(e).div(100).toFixed(2)}}if(b>=l){b=0}for(var p=0;p<s.length;p++){var t=s[p];if(b==0&&r==h){t.exceptionFlag='"error"'}t.gpDiscount=t.qty.mul(t.taxPrice).mul(b).div(l).toFixed(2);if(!t.gpDiscount){t.gpDiscount=0}s[p]=t}m=balancePriceForItems(b,s)}return m}function calculateInItemLevelTypePCT(h,c,e,o){var n=0;var j=new Array();var f=new Array();if(h!=null&&c.size()>0){if(h.groups.length>1){return}var g=false;var b=0;var a=c.keys()[0];var f=c.get(a);var m=0;var l;for(var d=0;d<f.length;d++){l=f[d];m+=l.qty;b=b.add(l.qty.mul(l.taxPrice));j.push(l)}if(a==h.groups[0].groupSeq){var k=h.groups[0];g=m>=k.thresholdQty}if(g){n=b.mul(h.discountFactor).div(100).toFixed(2)}if(n>=b){n=0}for(var d=0;d<j.length;d++){var l=j[d];if(n==0&&e==o){l.exceptionFlag='"error"'}l.gpDiscount=l.qty.mul(l.taxPrice).mul(n).div(b).toFixed(2);if(!l.gpDiscount){l.gpDiscount=0}j[d]=l}f=balancePriceForItems(n,j)}return f}function calculateInItemLevelTypeFixed(a,n,o,g){var b=0;var q=new Array();var j=new Array();if(a!=null&&n.size()>0){if(a.groups.length>1){return}var e=n.keys()[0];var j=n.get(e);j.sort(function(v,u){return u.taxPrice-v.taxPrice});var l=0;var k=0;for(var m=0;m<j.length;m++){k=k.add(j[m].qty.mul(j[m].taxPrice));l+=j[m].qty;q.push(j[m])}var t=a.groups;var d;for(var m=0;m<t.length;m++){var s=t[m];if(s.groupSeq==e){d=s}}var f=0;var c=0;if(d!=null){f=parseInt(l/d.thresholdQty,10);c=f*d.thresholdQty}var p=0;for(var m=0;m<j.length;m++){r=j[m];if(c>=r.qty){p=p.add(r.qty.mul(r.taxPrice));c-=r.qty}else{p=p.add(c.mul(r.taxPrice));break}}var h=f.mul(a.discountFactor);if(p>h){b=p.sub(h)}if(b>=k){b=0}for(var m=0;m<q.length;m++){var r=q[m];if(b==0&&o==g){r.exceptionFlag='"error"'}r.gpDiscount=r.qty.mul(r.taxPrice).mul(b).div(k).toFixed(2);if(!r.gpDiscount){r.gpDiscount=0}q[m]=r}j=balancePriceForItems(b,q)}return j}function objToJSON(e){var b="{";var c;for(var d in e){c=e[d];if(c!="undefined"&&(typeof c!="function")){if(typeof c=="object"){if(c.length&&(c.length>0)){b+='"'+d+'":[';for(var a=0;a<c.length;a++){b+=objToJSON(c[a])+","}b=b.substring(0,b.length-1);b+="],"}else{if(c.length==0){b+='"'+d+'":[],'}else{b+=objToJSON(c)}}}else{b+='"'+d+'":'+c+","}}}b=b.substring(0,b.length-1);b+="}";return b}function JSONToString(c){var b;if(c.length&&(c.length>0)){b="[";for(var a=0;a<c.length;a++){b+=objToJSON(c[a])+","}b=b.substring(0,b.length-1);b+="]"}else{if(c.length==0){return"[]"}else{b=objToJSON(c)}}return b}function getPromotionInfo(cartItems){var cart;CAL_STRING="cal";cartItems=eval("("+cartItems+")");var resultArray=new Array();var itemsArray=new Array();var obj;var cartItem;for(var i=0;i<cartItems.length;i++){cartItem=cartItems[i];if(cartItem.length>0){obj=new Object();obj.offerId=cartItem[0].offerId;var offerTypeCode=cartItem[0].offerTypeCode;var offer=getOfferById(obj.offerId);var cartMaps=getMapCartItem(cartItem);var groupMaps=cartMaps.values()[0];var desc=isRemind(offer,groupMaps);if(!desc){obj.tips='""';obj.totalDiscount=0;obj.items=[]}else{var items=calculateInItemLevel(cartItem,desc,CAL_STRING);if(desc!=CAL_STRING){obj.tips='"'+desc+'"'}else{var itemDiscount=0;for(var j=0;j<items.length;j++){itemDiscount=itemDiscount.add(items[j].gpDiscount).toFixed(2)}var offerGroups=offer&&offer.groups;if(itemDiscount==0){if(offerTypeCode>0){obj.tips='"促销不可用"';obj.errorCode="-1"}else{if(offerGroups.length==1){obj.tips='"促销不可用"';obj.errorCode="-1"}}}else{obj.tips='""'}}itemsArray.push(items);obj.items=items}obj.offerDesc='""';obj.offerDescCn='""';if(offer&&offer.promotionDescCn){obj.offerDesc='"'+offer.promotionDescCn+'"'}if(offer&&offer.promotionDesc){obj.offerDescCn='"'+offer.promotionDesc+'"'}resultArray.push(obj)}}resultArray.sort(function(a,b){return a.offerId-b.offerId});var itemsDiscountMap=new WMCMap();for(var j=0;j<resultArray.length;j++){var gpCartItems=resultArray[j];var exceptionFlag=validateGpOffer(gpCartItems,itemsDiscountMap);sumItemDiscount(gpCartItems,itemsDiscountMap,exceptionFlag)}return JSONToString(resultArray)}function sumItemDiscount(g,c,e){var b=0;if(e){g.tips='"促销不可用"';g.errorCode="-1";g.totalDiscount=0;for(var f=0;f<g.items.length;f++){g.items[f].gpDiscount=0}}else{for(var d=0;d<g.items.length;d++){var h=g.items[d];var a=c.get(h.productId).add(h.gpDiscount).toFixed(2);c.put(h.productId,a);b=b.add(h.gpDiscount).toFixed(2)}g.totalDiscount=b}}function validateGpOffer(f,b){var c=false;for(var e=0;e<f.items.length;e++){var h=f.items[e];if(!b.containsKey(h.productId)){b.put(h.productId,0)}var g=b.get(h.productId);var a=b.get(h.productId).add(h.gpDiscount).toFixed(2);var d=h.qty.mul(h.taxPrice).toFixed(2);if(a.sub(d)>=0){c=true;h.exceptionFlag='"error"'}}return c}function balancePriceForItems(b,c){if(c.length>0){if(c[0].productId!=null&&c[0].items!=""&&c[0].productId!=undefined){c.sort(function(k,j){return k.productId-j.productId})}else{c.sort(function(k,j){return k.upc-j.upc})}var e=0;for(var d=0;d<c.length;d++){e=e.add(c[d].gpDiscount)}if(b!=e){var g=b.sub(e);var f=parseInt(Math.abs(g)*100/c.length,10);var h=Math.abs(g)*100%c.length;var a=g/Math.abs(g);for(var d=0;d<c.length;d++){c[d].gpDiscount=c[d].gpDiscount.add(f.mul(0.01).mul(a));if(h>d){c[d].gpDiscount=c[d].gpDiscount.add(0.01.mul(a))}}}}return c}function balancePriceForItemsV2(b,c){c.sort(function(k,j){return k.productId-j.productId});var e=0;for(var d=0;d<c.length;d++){e=e.add(c[d].taxPrice)}if(b!=e){var g=b.sub(e);var f=parseInt(Math.abs(g)*100/c.length,10);var h=Math.abs(g)*100%c.length;var a=g/Math.abs(g);for(var d=0;d<c.length;d++){c[d].taxPrice=c[d].taxPrice.add(f.mul(0.01).mul(a));if(h>d){c[d].taxPrice=c[d].taxPrice.add(0.01.mul(a))}}}return c}function isRemind(b,d){var v;var e=0;var g=0;var k=b&&b.groups;var h;var j;var r;var o;var n;var s=new Array();if(!k){return false}for(var q=0;q<k.length;q++){h=k[q];g=h.thresholdQty;j=h.groupSeq;n=h.thresholdAmt;o=h.tieredDiscount;r=d.get(j);if(!r){break}var f=0;var l=0;var a=0;for(var t=0;t<r.length;t++){l=r[t].qty;a=(a+r[t].taxPrice*l).toFixed(2);f+=r[t].qty}var m=new Object();m.relQty=f;m.minQty=g;m.thresholdAmt=n;m.tieredDiscount=o;m.relTaxPrice=a;s.push(m);e++}var m=s[0];if(b.gpCaclTypeCode==PROMOTION_TYPE_AMT||b.gpCaclTypeCode==PROMOTION_TYPE_AMT_ONLINE){v=CAL_STRING;if(k.length==1){if(e==1){if(b.gpCaclTypeCode==PROMOTION_TYPE_AMT){if(g>m.relQty){v="再购买"+(g-m.relQty)+"件就可以享受"+(b.discountFactor).toFixed(2)+"元的优惠"}}else{if(n>m.relTaxPrice){v="再购买"+(n-m.relTaxPrice).toFixed(2)+"元就可以享受"+(b.discountFactor).toFixed(2)+"元的优惠"}}}}}else{if(b.gpCaclTypeCode==PROMOTION_TYPE_PCT){if(m.relQty<g){v="再购买"+(m.minQty-m.relQty)+"件就可以享受"+(100-b.discountFactor).div(10)+"折的优惠"}else{v=CAL_STRING}}else{if(b.gpCaclTypeCode==PROMOTION_TYPE_AMT_TIERED||b.gpCaclTypeCode==PROMOTION_TYPE_PCT_TIERED){var o=m.tieredDiscount;o.sort(function(w,p){return w.thresholdQty-p.thresholdQty});var g=0;var f=m.relQty;var a=m.relTaxPrice;var c;var u=-1;for(var t=0;t<o.length;t++){u=t;if(f<=o[t].thresholdQty){g=o[t].thresholdQty;c=o[t].discountFactor;break}}if(b.gpCaclTypeCode==PROMOTION_TYPE_AMT_ONLINE_TIERED){if(g>m.relTaxPrice&&u==0){v="再购买"+(g-m.relTaxPrice).toFixed(2)+"元就可以享受"+c.toFixed(2)+"元的优惠"}else{v=CAL_STRING}}else{if(g>m.relQty&&u==0){if(b.gpCaclTypeCode==PROMOTION_TYPE_AMT_TIERED){v="再购买"+(g-m.relQty)+"件就可以享受"+c.toFixed(2)+"元的优惠"}else{v="再购买"+(g-m.relQty)+"件就可以享受"+(100-c).div(10)+"折的优惠"}}else{v=CAL_STRING}}}else{if(b.gpCaclTypeCode==PROMOTION_TYPE_FIXED){if(m.minQty>m.relQty){v="再购买"+(m.minQty-m.relQty)+"件就可以享受总价格"+(b.discountFactor).toFixed(2)+"元"}else{v=CAL_STRING}}}}}return v}function getPromotionInfoForAndroid(a){window.javaKey.onDiscountBack(getPromotionInfo(a))};